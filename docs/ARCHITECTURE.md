# ABService アーキテクチャ設計書

## 概要

ABServiceは、モノリポジトリ構成で構築されたWebサービスです。バックエンドはQuarkus、フロントエンドは管理画面をSvelte、公開画面をSvelte + Astroで構築します。

## 技術スタック

### バックエンド
- **フレームワーク**: Quarkus 3.x
- **Java**: 25+
- **データベース**: PostgreSQL
- **データアクセス**: Blaze-Persistence (JPA拡張)
- **マイグレーション**: Flyway
- **認証・認可**: 
  - Quarkus OIDC (Keycloak統合)
  - Quarkus Security (RBAC)
  - SmallRye JWT
- **API**: RESTEasy Reactive
- **設定管理**: Quarkus Configuration
- **テスト**: JUnit 5 + REST Assured

### フロントエンド
- **管理画面**: Svelte + SvelteKit
- **公開画面**: Svelte + Astro
- **共通**: TypeScript, ESLint, Prettier

### インフラ・開発環境
- **コンテナ**: Docker & Docker Compose
- **データベース**: PostgreSQL
- **認証サーバー**: Keycloak (開発環境)

## システム構成

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  Frontend Admin │    │ Frontend Public │    │    Backend      │
│     (Svelte)    │    │ (Svelte + Astro)│    │   (Quarkus)     │
│   Port: 5173    │    │   Port: 4321    │    │   Port: 8080    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   PostgreSQL    │
                    │   Port: 5432    │
                    └─────────────────┘
                                 │
                    ┌─────────────────┐
                    │   Keycloak      │
                    │   Port: 8180    │
                    └─────────────────┘
```

## 認証・認可アーキテクチャ

### 認証方式
- **外部IDプロバイダー**: Keycloak
- **プロトコル**: OpenID Connect (OIDC)
- **トークン**: JWT (アクセストークン + リフレッシュトークン)
- **セッション**: ステートレス（JWTベース）

### 認可方式
- **ロールベースアクセス制御 (RBAC)**: ユーザーロールによる権限管理
- **スコープベース認可**: リソースアクセス権限の細かい制御
- **アノテーション**: `@RolesAllowed`, `@PermitAll`, `@DenyAll`

### セキュリティフロー
1. ユーザーがフロントエンドにアクセス
2. 未認証の場合はKeycloakにリダイレクト
3. Keycloakで認証後、JWTトークンを取得
4. フロントエンドがJWTトークンをバックエンドAPIに送信
5. バックエンドがJWTトークンを検証し、認可を実行

## データアクセス層

### Blaze-Persistence採用理由
- **高度なクエリ機能**: JPAのCriteria APIを拡張
- **エンティティビュー**: DTOの効率的なマッピング
- **パフォーマンス最適化**: 必要なデータのみを取得
- **動的クエリ**: 複雑な検索条件の動的構築

### データベース設計方針
- **正規化**: 第3正規形を基本とする
- **インデックス**: パフォーマンス要件に応じて適切に配置
- **マイグレーション**: Flywayによるバージョン管理
- **バックアップ**: 定期的なバックアップとリストア手順

## API設計

### RESTful API原則
- **リソース指向**: URLでリソースを表現
- **HTTPメソッド**: GET, POST, PUT, DELETEの適切な使用
- **ステータスコード**: 標準的なHTTPステータスコード
- **エラーハンドリング**: 統一されたエラーレスポンス形式

### API仕様
- **OpenAPI**: Swagger UIによるAPI仕様書
- **バージョニング**: URLパスでのバージョン管理
- **認証**: Bearer Token (JWT)
- **レート制限**: 必要に応じて実装

## フロントエンド設計

### 管理画面 (Svelte)
- **SPA**: シングルページアプリケーション
- **状態管理**: Svelte Store
- **ルーティング**: SvelteKit
- **UIコンポーネント**: 再利用可能なコンポーネント設計

### 公開画面 (Svelte + Astro)
- **SSG/SSR**: Astroによる静的サイト生成
- **パフォーマンス**: 最適化されたバンドルサイズ
- **SEO**: メタタグと構造化データ
- **アクセシビリティ**: WCAG 2.1準拠

## 開発・運用

### 開発環境
- **ローカル開発**: Docker Compose
- **ホットリロード**: 全サービス対応
- **デバッグ**: 各サービス個別デバッグ対応

### テスト戦略
- **単体テスト**: 各コンポーネントのテスト
- **統合テスト**: APIエンドポイントのテスト
- **E2Eテスト**: ユーザーシナリオのテスト
- **パフォーマンステスト**: 負荷テスト

### デプロイメント
- **コンテナ化**: Dockerイメージ
- **CI/CD**: GitHub Actions
- **環境**: 開発、ステージング、本番
- **監視**: ログ、メトリクス、アラート

## セキュリティ考慮事項

### データ保護
- **暗号化**: 通信時（TLS）と保存時（AES）
- **個人情報**: GDPR準拠
- **アクセスログ**: 監査証跡の保持

### 脆弱性対策
- **依存関係**: 定期的な脆弱性スキャン
- **セキュリティヘッダー**: CSP, HSTS等の設定
- **入力検証**: 全入力の適切な検証

## パフォーマンス要件

### レスポンス時間
- **API**: 95%ile < 200ms
- **ページロード**: 初回 < 3秒、以降 < 1秒
- **データベース**: クエリ < 100ms

### スケーラビリティ
- **水平スケーリング**: コンテナベース
- **キャッシュ**: Redis導入検討
- **CDN**: 静的リソース配信

## 今後の拡張計画

### マイクロサービス化
- **サービス分割**: ドメイン駆動設計
- **API Gateway**: 統一エントリーポイント
- **サービスメッシュ**: Istio導入検討

### 機能拡張
- **リアルタイム通信**: WebSocket
- **ファイルアップロード**: オブジェクトストレージ
- **通知機能**: メール、プッシュ通知
